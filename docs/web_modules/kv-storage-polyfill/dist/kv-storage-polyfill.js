const U=function(){function n(){}return n.prototype.then=function(t,e){const r=new n,c=this.s;if(c){const u=1&c?t:e;if(u){try{v(r,1,u(this.v))}catch(o){v(r,2,o)}return r}return this}return this.o=function(u){try{const o=u.v;1&u.s?v(r,1,t?t(o):o):e?v(r,1,e(o)):v(r,2,o)}catch(o){v(r,2,o)}},r},n}();function v(n,t,e){if(!n.s){if(e instanceof U){if(!e.s)return void(e.o=v.bind(null,n,t));1&t&&(t=e.s),e=e.v}if(e&&e.then)return void e.then(v.bind(null,n,t),v.bind(null,n,2));n.s=t,n.v=e;const r=n.o;r&&r(n)}}var Q=0,k=typeof WeakMap=="function"?WeakMap:function(){var n=typeof Symbol=="function"?Symbol(0):"__weak$"+ ++Q;this.set=function(t,e){t[n]=e},this.get=function(t){return t[n]}};function M(n,t){return new Promise(function(e,r){n.onsuccess=function(){var c=n.result;t&&(c=t(c)),e(c)},n.onerror=function(){r(n.error)}})}function V(n,t){return M(n.openCursor(t),function(e){return e?[e.key,e.value]:[]})}function Y(n){return new Promise(function(t,e){n.oncomplete=function(){t()},n.onabort=function(){e(n.error)},n.onerror=function(){e(n.error)}})}function R(n){if(!function(t){if(typeof t=="number"||typeof t=="string")return!0;if(typeof t=="object"&&t){if(Array.isArray(t))return!0;if("setUTCFullYear"in t)return!0;if(typeof ArrayBuffer=="function"&&ArrayBuffer.isView(t))return!0;if("byteLength"in t&&"length"in t)return!0}return!1}(n))throw Error("kv-storage: The given value is not allowed as a key")}var $={};function q(n,t){return V(n,z(t))}function z(n){return n===$?IDBKeyRange.lowerBound(-Infinity):IDBKeyRange.lowerBound(n,!0)}var G=new k,T=new k,E=new k,H=new k,N=function(){};function J(n,t){return t(function(e,r){try{function c(){return T.set(n,o),E.set(n,void 0),{value:a,done:o===void 0}}var u=T.get(n);if(u===void 0)return Promise.resolve({value:void 0,done:!0});var o,h,a,l=function(f,i){var p,s=-1;n:{for(var d=0;d<i.length;d++){var B=i[d][0];if(B){var x=B();if(x&&x.then)break n;if(x===f){s=d;break}}else s=d}if(s!==-1){do{for(var C=i[s][1];!C;)C=i[++s][1];var A=C();if(A&&A.then){p=!0;break n}var L=i[s][2];s++}while(L&&!L());return A}}const j=new U,D=v.bind(null,j,2);return(p?A.then(K):x.then(function P(b){for(;;){if(b===f){s=d;break}if(++d===i.length){if(s!==-1)break;return void v(j,1,I)}if(B=i[d][0]){if((b=B())&&b.then)return void b.then(P).then(void 0,D)}else s=d}do{for(var g=i[s][1];!g;)g=i[++s][1];var I=g();if(I&&I.then)return void I.then(K).then(void 0,D);var O=i[s][2];s++}while(O&&!O());v(j,1,I)})).then(void 0,D),j;function K(P){for(;;){var b=i[s][2];if(!b||b())break;for(var g=i[++s][1];!g;)g=i[++s][1];if((P=g())&&P.then)return void P.then(K).then(void 0,D)}v(j,1,P)}}(H.get(n),[[function(){return"keys"},function(){return Promise.resolve(function(f,i){return V(f,z(i)).then(function(p){return p[0]})}(r,u)).then(function(f){a=o=f})}],[function(){return"values"},function(){return Promise.resolve(q(r,u)).then(function(f){var i;o=(i=f)[0],a=h=i[1]})}],[function(){return"entries"},function(){return Promise.resolve(q(r,u)).then(function(f){var i;h=(i=f)[1],a=(o=i[0])===void 0?void 0:[o,h]})}]]);return Promise.resolve(l&&l.then?l.then(c):c())}catch(f){return Promise.reject(f)}})}function W(n,t){var e=new N;return H.set(e,n),G.set(e,t),T.set(e,$),E.set(e,void 0),e}N.prototype.return=function(){T.set(this,void 0)},N.prototype.next=function(){var n=this,t=G.get(this);if(!t)return Promise.reject(new TypeError("Invalid this value"));var e,r=E.get(this);return e=r!==void 0?r.then(function(){return J(n,t)}):J(this,t),E.set(this,e),e},typeof Symbol=="function"&&Symbol.asyncIterator&&(N.prototype[Symbol.asyncIterator]=function(){return this});var S=function(n,t,e){try{return m.get(n)===null&&function(r){var c=_.get(r);m.set(r,new Promise(function(u,o){var h=self.indexedDB.open(c,1);h.onsuccess=function(){var a=h.result;(function(l,f,i){if(l.objectStoreNames.length!==1)return i(F(f)),!1;if(l.objectStoreNames[0]!==w)return i(F(f)),!1;var p=l.transaction(w,"readonly").objectStore(w);return!(p.autoIncrement||p.keyPath||p.indexNames.length)||(i(F(f)),!1)})(a,c,o)&&(a.onclose=function(){m.set(r,null)},a.onversionchange=function(){a.close(),m.set(r,null)},u(a))},h.onerror=function(){return o(h.error)},h.onupgradeneeded=function(){try{h.result.createObjectStore(w)}catch(a){o(a)}}}))}(n),Promise.resolve(m.get(n)).then(function(r){var c=r.transaction(w,t),u=c.objectStore(w);return e(c,u)})}catch(r){return Promise.reject(r)}},_=new k,m=new k,w="store",y=function(n){var t="kv-storage:"+n;m.set(this,null),_.set(this,t),this.backingStore={database:t,store:w,version:1}};y.prototype.set=function(n,t){try{return R(n),S(this,"readwrite",function(e,r){return t===void 0?r.delete(n):r.put(t,n),Y(e)})}catch(e){return Promise.reject(e)}},y.prototype.get=function(n){try{return R(n),S(this,"readonly",function(t,e){return M(e.get(n))})}catch(t){return Promise.reject(t)}},y.prototype.delete=function(n){try{return R(n),S(this,"readwrite",function(t,e){return e.delete(n),Y(t)})}catch(t){return Promise.reject(t)}},y.prototype.clear=function(){try{var n=this;function t(){function u(){return M(self.indexedDB.deleteDatabase(_.get(n)))}var o=function(){if(e){try{e.close()}catch(h){}return Promise.resolve(new Promise(setTimeout)).then(function(){})}}();return o&&o.then?o.then(u):u()}var e,r=m.get(n),c=function(){if(r!==null){function u(){m.set(n,null)}var o=function(h,a){try{var l=Promise.resolve(r).then(function(f){e=f})}catch(f){return}return l&&l.then?l.then(void 0,function(){}):l}();return o&&o.then?o.then(u):u()}}();return c&&c.then?c.then(t):t()}catch(u){return Promise.reject(u)}},y.prototype.keys=function(){var n=this;return W("keys",function(t){return S(n,"readonly",t)})},y.prototype.values=function(){var n=this;return W("values",function(t){return S(n,"readonly",t)})},y.prototype.entries=function(){var n=this;return W("entries",function(t){return S(n,"readonly",t)})},typeof Symbol=="function"&&Symbol.asyncIterator&&(y.prototype[Symbol.asyncIterator]=y.prototype.entries);var X=new y("default");function F(n){return new Error('kv-storage: database "'+n+'" corrupted')}export{y as StorageArea,X as storage};
